---
import { Image } from 'astro:assets';
import { company } from '@/data/site';
import ctxLogo from '@/assets/ctx-logo-green.png';

const pathname = Astro.url.pathname;
const isServicesRoute = pathname.startsWith('/services/') || pathname.includes('clearing') || pathname.includes('mulching') || pathname.includes('grading');
const isActive = (href: string) => {
  if (href === '/') return pathname === '/';
  if (href === '/services/') return isServicesRoute;
  return pathname.startsWith(href);
};
---
<header class="site-header screenshot-header">
  <div class="screenshot-socialbar" aria-label="Social links">
    <div class="container-standard flex items-center justify-end">
      <ul class="social-links" role="list">
        <li><a href="https://www.facebook.com/CTX-Land-Clearing-and-Forestry-Mulching-101605442531643" target="_blank" rel="noopener noreferrer" aria-label="Facebook"><span aria-hidden="true">f</span></a></li>
        <li><a href="https://www.instagram.com/ctxlandclearing" target="_blank" rel="noopener noreferrer" aria-label="Instagram"><span aria-hidden="true">ig</span></a></li>
        <li><a href="https://www.youtube.com/channel/UCH8nL1t2YOdsmuhE7mBqMlw" target="_blank" rel="noopener noreferrer" aria-label="YouTube"><span aria-hidden="true">yt</span></a></li>
        <li><a href="https://x.com/ctxlandclearing" target="_blank" rel="noopener noreferrer" aria-label="X"><span aria-hidden="true">x</span></a></li>
      </ul>
    </div>
  </div>

  <div class="screenshot-topbar">
    <div class="container-standard flex items-center justify-between gap-8 py-6">
      <a href="/" aria-label="CTX Land Clearing Home">
        <Image src={ctxLogo} alt="CTX Land Clearing and Forestry Mulching logo" width={430} height={140} class="site-logo h-auto w-[220px] md:w-[320px]" />
      </a>
      <div class="mobile-topbar-menu">
        <button
          class="mobile-menu-toggle"
          type="button"
          aria-expanded="false"
          aria-controls="mobile-nav-panel"
          aria-label="Open menu"
          data-mobile-menu-toggle
        >
          <span class="mobile-menu-icon" aria-hidden="true"></span>
          <span>Menu</span>
        </button>
      </div>
      <div class="hidden items-center gap-8 lg:flex">
        <a href="https://maps.app.goo.gl/eRKdYf6Wv16bUh4eA" target="_blank" rel="noopener noreferrer" class="topbar-item topbar-item-link" aria-label="View location map">
          <span class="topbar-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" class="h-5 w-5 fill-current"><path d="M12 2.3A7.4 7.4 0 0 0 4.6 9.7c0 5.5 7.4 12 7.4 12s7.4-6.5 7.4-12A7.4 7.4 0 0 0 12 2.3m0 10a2.6 2.6 0 1 1 0-5.2 2.6 2.6 0 0 1 0 5.2"/></svg>
          </span>
          <div>
            <p class="topbar-heading">Austin</p>
            <p class="topbar-text">Texas</p>
          </div>
        </a>
        <a href={`tel:${company.phoneHref}`} class="topbar-item topbar-item-link" data-track="call_click" aria-label={`Call ${company.phone}`}>
          <span class="topbar-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" class="h-5 w-5 fill-current"><path d="M6.6 10.8a15.5 15.5 0 0 0 6.6 6.6l2.2-2.2c.3-.3.8-.4 1.2-.3 1.3.4 2.6.6 4 .6.7 0 1.2.5 1.2 1.2V21c0 .7-.5 1.2-1.2 1.2C10.9 22.2 1.8 13.1 1.8 1.8 1.8 1.1 2.3.6 3 .6h4.5c.7 0 1.2.5 1.2 1.2 0 1.4.2 2.7.6 4 .1.4 0 .9-.3 1.2z"/></svg>
          </span>
          <div>
            <p class="topbar-heading">Call Us</p>
            <p class="topbar-text">{company.phone}</p>
          </div>
        </a>
        <a href="/contact-us/" class="topbar-item topbar-item-link" aria-label="Go to contact page">
          <span class="topbar-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" class="h-5 w-5 fill-current"><path d="M2 5.5A2.5 2.5 0 0 1 4.5 3h15A2.5 2.5 0 0 1 22 5.5v13a2.5 2.5 0 0 1-2.5 2.5h-15A2.5 2.5 0 0 1 2 18.5zm2.5-.5 7.5 5.3L19.5 5zm15.5 2-7.4 5.2a1 1 0 0 1-1.2 0L4 7v11.5c0 .3.2.5.5.5h15c.3 0 .5-.2.5-.5z"/></svg>
          </span>
          <div>
            <p class="topbar-heading">Contact Us</p>
            <p class="topbar-text">Free Estimate Form</p>
          </div>
        </a>
      </div>
    </div>
  </div>

  <div class="screenshot-nav-wrap">
    <div class="container-standard">
      <div class="screenshot-nav">
        <nav aria-label="Primary" class="nav-links">
          <a href="/" class={isActive('/') ? 'is-active' : undefined}>Home</a>
          <a href="/about-us/" class={isActive('/about-us/') ? 'is-active' : undefined}>About Us</a>
          <div class="nav-item nav-item-services">
            <a href="/services/" class={isActive('/services/') ? 'is-active' : undefined} aria-haspopup="true" aria-expanded={isActive('/services/') ? 'true' : 'false'}>
              Services
              <span class="nav-caret" aria-hidden="true">
                <svg viewBox="0 0 20 20" class="h-4 w-4 fill-current"><path d="M5.3 7.2 10 12l4.7-4.8-1.4-1.4L10 9.1 6.7 5.8z" /></svg>
              </span>
            </a>
            <div class="nav-dropdown" role="menu" aria-label="Services menu">
              <a href="/lot-clearing-central-texas/" role="menuitem">Lot Clearing Austin Texas</a>
              <a href="/land-grading-central-texas/" role="menuitem">Land Grading Central Texas</a>
              <a href="/land-clearing-services-central-texas/" role="menuitem">Land Clearing Services Central Texas</a>
              <a href="/forestry-mulching-central-texas/" role="menuitem">Forestry Mulching Central Texas</a>
            </div>
          </div>
          <a href="/contact-us/" class={isActive('/contact-us/') ? 'is-active' : undefined}>Free Estimate</a>
        </nav>
        <a href={`tel:${company.phoneHref}`} class="nav-call" data-track="call_click">{company.phone}</a>
      </div>
    </div>
  </div>

  <div class="mobile-nav-overlay" hidden data-mobile-nav-overlay></div>
  <aside id="mobile-nav-panel" class="mobile-nav-panel" aria-label="Mobile menu" hidden data-mobile-nav-panel>
    <div class="mobile-nav-head">
      <p>Menu</p>
      <button type="button" class="mobile-nav-close" aria-label="Close menu" data-mobile-menu-close>Close</button>
    </div>
    <nav aria-label="Mobile primary navigation" class="mobile-nav-links">
      <a href="/" class={isActive('/') ? 'is-active' : undefined}>Home</a>
      <a href="/about-us/" class={isActive('/about-us/') ? 'is-active' : undefined}>About Us</a>
      <details class="mobile-services-group" open={isActive('/services/')}>
        <summary class={isActive('/services/') ? 'is-active' : undefined}>Services</summary>
        <div class="mobile-services-list">
          <a href="/services/">All Services</a>
          <a href="/lot-clearing-central-texas/" class="mobile-subservice"><span aria-hidden="true">&gt;</span>Lot Clearing Austin Texas</a>
          <a href="/land-grading-central-texas/" class="mobile-subservice"><span aria-hidden="true">&gt;</span>Land Grading Central Texas</a>
          <a href="/land-clearing-services-central-texas/" class="mobile-subservice"><span aria-hidden="true">&gt;</span>Land Clearing Services Central Texas</a>
          <a href="/forestry-mulching-central-texas/" class="mobile-subservice"><span aria-hidden="true">&gt;</span>Forestry Mulching Central Texas</a>
        </div>
      </details>
      <a href="/service-areas/" class={isActive('/service-areas/') ? 'is-active' : undefined}>Service Areas</a>
      <a href="/faqs/" class={isActive('/faqs/') ? 'is-active' : undefined}>FAQs</a>
      <a href="/contact-us/" class={isActive('/contact-us/') ? 'is-active' : undefined}>Free Estimate</a>
    </nav>
    <div class="mobile-nav-cta">
      <a href={`tel:${company.phoneHref}`} class="btn-primary w-full text-center" data-track="call_click">Call {company.phone}</a>
    </div>
  </aside>
</header>

<script>
  const body = document.body;
  const toggle = document.querySelector('[data-mobile-menu-toggle]');
  const close = document.querySelector('[data-mobile-menu-close]');
  const overlay = document.querySelector('[data-mobile-nav-overlay]');
  const panel = document.querySelector('[data-mobile-nav-panel]');
  const panelLinks = panel ? panel.querySelectorAll('a') : [];

  if (toggle && close && overlay && panel) {
    const setOpen = (open) => {
      toggle.setAttribute('aria-expanded', open ? 'true' : 'false');
      panel.hidden = !open;
      overlay.hidden = !open;
      body.classList.toggle('mobile-menu-open', open);
      if (open) {
        close.focus();
      } else {
        toggle.focus();
      }
    };

    toggle.addEventListener('click', () => setOpen(panel.hidden));
    close.addEventListener('click', () => setOpen(false));
    overlay.addEventListener('click', () => setOpen(false));
    panelLinks.forEach((link) => {
      link.addEventListener('click', () => setOpen(false));
    });
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Escape' && !panel.hidden) {
        setOpen(false);
      }
    });
  }

  const header = document.querySelector('.site-header');
  const mobileQuery = window.matchMedia('(max-width: 767px)');
  const compactScrollOffset = 36;
  const syncCompactHeader = () => {
    if (!header) return;
    const isMobile = mobileQuery.matches;
    const shouldCompact = isMobile && window.scrollY > compactScrollOffset;
    header.classList.toggle('is-compact', shouldCompact);
  };

  syncCompactHeader();
  window.addEventListener('scroll', syncCompactHeader, { passive: true });
  window.addEventListener('resize', syncCompactHeader);
</script>
